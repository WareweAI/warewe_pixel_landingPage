{% comment %}
  Pixel Tracker - Theme App Extension (App Embed)
  Injects tracking script into storefront
{% endcomment %}

{% if block.settings.enable_tracking %}
<script>
(function() {
  'use strict';
  
  var SHOP = '{{ shop.permanent_domain }}';
  var DEBUG = true;
  
  // Use App Proxy URL (same-origin, no CORS)
  var PROXY_URL = '/apps/pixel-api';
  
  if (DEBUG) console.log('[PixelTracker] Starting for shop:', SHOP);
  
  // Fetch pixel config
  fetch(PROXY_URL + '/get-pixel-id?shop=' + encodeURIComponent(SHOP))
    .then(function(res) {
      if (DEBUG) console.log('[PixelTracker] Config response:', res.status);
      return res.json();
    })
    .then(function(data) {
      if (DEBUG) console.log('[PixelTracker] Config data:', data);
      
      if (data.error) {
        console.warn('[PixelTracker] Error:', data.error);
        return;
      }
      
      window.PIXEL_TRACKER_ID = data.pixelId;
      window.PIXEL_TRACKER_CONFIG = data.config || {};
      
      // Load the tracking script
      var script = document.createElement('script');
      script.async = true;
      script.src = PROXY_URL + '/pixel.js?id=' + data.pixelId + '&shop=' + encodeURIComponent(SHOP);
      script.onload = function() {
        if (DEBUG) console.log('[PixelTracker] Script loaded successfully');
      };
      script.onerror = function(e) {
        console.error('[PixelTracker] Script load error:', e);
      };
      document.head.appendChild(script);
      
      // Load Facebook Pixel if configured
      if (data.metaPixelId && data.enabled) {
        !function(f,b,e,v,n,t,s)
        {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
        n.callMethod.apply(n,arguments):n.queue.push(arguments)};
        if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
        n.queue=[];t=b.createElement(e);t.async=!0;
        t.src=v;s=b.getElementsByTagName(e)[0];
        s.parentNode.insertBefore(t,s)}(window, document,'script',
        'https://connect.facebook.net/en_US/fbevents.js');
        fbq('init', data.metaPixelId);
        fbq('track', 'PageView');
        if (DEBUG) console.log('[PixelTracker] FB Pixel initialized:', data.metaPixelId);
      }
    })
    .catch(function(err) {
      console.error('[PixelTracker] Fetch error:', err);
    });
})();
</script>
{% endif %}

{% schema %}
{
  "name": "Pixel Tracker",
  "target": "body",
  "settings": [
    {
      "type": "checkbox",
      "id": "enable_tracking",
      "label": "Enable Tracking",
      "default": true
    }
  ]
}
{% endschema %}
